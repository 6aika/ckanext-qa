<html xmlns:py="http://genshi.edgewall.org/"
  xmlns:i18n="http://genshi.edgewall.org/i18n"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  py:strip="">

  <py:def function="page_title">Quality Assurance</py:def>

<py:def function="body_class">no-sidebar</py:def>

  <py:def function="optional_head">
    <script type="text/javascript" src="http://assets.okfn.org/ext/flot/0.6/jquery.flot.min.js">//pointless jscript comment</script>
    <link type="text/css" rel="stylesheet" media="all" href="/css/ckanext-qa.css" />
  </py:def>

  <div py:match="content">
    <div class="qa-content">
      <h1>Quality Assurance</h1>
      <py:if test="(not c.data) or (not c.data['broken_resources'])">
        <p>No results found for this organization.</p>
      </py:if>

      <py:if test="c.data and c.data['broken_resources']">
        <div class="pull-right">
            <a class="btn" href="${h.url_for('qa_api_resource_formatted', action=c.query.__name__, id=c.org_name, format='csv')}">Download report in CSV format</a>
        </div>
        <h2>Broken Links -
          <a href="/publisher/${c.data['publisher_name']}">
            ${c.data['publisher_title']}
          </a>
</h2>
        <table class="table table-striped table-bordered table-condensed"  style="width: 100%; table-layout: fixed;">
            <tr>
              <th class="qa-table-name" style="width: 150px">Dataset</th>
              <th class="qa-table-name" style="width: 50px">Resource index</th>
              <th class="qa-table-name" style="width: 200px">Resource URL</th>
              <th class="qa-table-name" style="width: 200px">Reason</th>
              <th class="qa-table-name">Number of failed download attempts</th>
              <th class="qa-table-name">Last attempt</th>
              <th class="qa-table-name">Last successful attempt</th>
            </tr>
            <tr py:for="row_dict in c.data['broken_resources']">
              <td><a href="${h.url_for(controller='package', action='read', id=row_dict['package_name'])}">${row_dict['package_title']}</a></td>
              <td><a href="/dataset/${row_dict['package_name']}/resource/${row_dict['resource_id']}">${row_dict['resource_position']}</a></td>
              <td><a href="${row_dict['resource_url']}" style="word-wrap:break-word;">${row_dict['resource_url']}</a></td>
              <td>${row_dict.get('openness_score_reason', 'not recorded')}</td>
              <td>${row_dict.get('openness_score_failure_count', 'not recorded')}</td>
              <td>${row_dict.get('openness_score_updated').strftime('%d/%m/%Y  %H:%M') if row_dict.get('openness_score_updated') else 'not recorded'}</td>
<?python
last_success = row_dict.get('openness_score_last_success')
if last_success:
    import datetime, re
    # convert to datetime
    last_success = datetime.datetime(*map(int, re.split('[^\d]', last_success)[:-1]))
    last_success = last_success.strftime('%d/%m/%Y %H:%M') + ' '
?>
              <td>${last_success or 'not recorded'}</td>
            </tr>
        </table>
      </py:if>
    </div>
  </div>
  <xi:include href="../../../../layout.html" />
</html>

