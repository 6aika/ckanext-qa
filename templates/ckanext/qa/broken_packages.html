<html xmlns:py="http://genshi.edgewall.org/"
  xmlns:i18n="http://genshi.edgewall.org/i18n"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  py:strip="">

  <py:def function="page_title">Quality Assurance</py:def>

  <py:def function="optional_head">
    <!--[if IE]><script language="javascript" type="text/javascript" src="http://assets.okfn.org/ext/flot/0.6/excanvas.min.js"></script><![endif]-->
    <script type="text/javascript" src="http://assets.okfn.org/ext/flot/0.6/jquery.flot.min.js">//pointless jscript comment</script>
    <link type="text/css" rel="stylesheet" media="all" href="/ckanext/qa/style.css" />
  </py:def>

  <div py:match="content" class="qa-content">
    <h1>Quality Assurance</h1>
  
    <h3>Broken packages</h3>
    <table class="qa-table">
      <tr>
          <th class="qa-table-name">Package name</th>
          <th class="qa-table-score">Overall Score</th>
          <th class="qa-table-resources">Resources</th>
          <th class="qa-table-checked">Last checked</th>
      </tr>
      <tr py:for="package in c.broken_packages">
        <td>${package.name}</td><td>${package.extras.get('openness_score')}</td>
        <td>
            <table>
                <tr>
                    <th>URL</th>
                    <th>Format</th>
                    <th>Score</th>
                </tr>
                <py:for each="resource in package.resources">
                <?python
                    score = resource.extras.get('openness_score')
                    is_bad_link = True if not bool(score) else False
                    is_good_link = bool(not is_bad_link)
                ?>
                <tr class="${h.css_classes([('bad_link', is_bad_link), ('good_link', is_good_link)])}">
                    <td><a href="${resource.url}" title="${resource.url}">${h.truncate(resource.description, 30)}</a></td>
                    <td>${resource.format}</td>
                    <td title="${resource.extras.get('openness_score_reason')}">${resource.extras.get('openness_score')}</td>
                </tr>
                </py:for>
            </table>
        </td>
        <?python
            from datetime import datetime
            timestamp = datetime.strptime(package.extras.get('openness_score_last_checked'),'%Y-%m-%dT%H:%M:%S.%f')
        ?>
        <td>${timestamp.strftime('%c')}</td>
      </tr>
    </table>

    <p>
      Page last updated:
       <?python 
          import datetime
       ?>
      ${datetime.datetime.now().strftime('%c')}
    </p>
  </div>

  <xi:include href="../../layout.html" />
</html>
